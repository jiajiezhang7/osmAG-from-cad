# osmAG文件自动修复工具套件

## 概述

本套件包含两个专门的osmAG XML文件自动修复工具，分别针对Fix_ID版本和Semantic版本的osmAG文件进行自动修复。这些工具基于相应的兼容性验证工具检测出的问题类型，提供安全、智能的自动修复功能。

## 工具列表

### 1. Fix_ID版本自动修复工具
- **文件名**：`auto_fix_osmag_fixid.py`
- **目标**：修复fix_id版本osmAG文件的常见问题
- **验证工具**：基于 `test_compatibility.py`

### 2. Semantic版本自动修复工具
- **文件名**：`auto_fix_osmag_semantic.py`
- **目标**：修复semantic版本osmAG文件的特有问题
- **验证工具**：基于 `test_compatibility_semantic.py`

## 修复能力对比

| 修复类型 | Fix_ID版本工具 | Semantic版本工具 | 说明 |
|----------|----------------|------------------|------|
| **根元素标准化** | ✅ | ✅ | 版本号、generator属性 |
| **属性标准化** | ✅ | ✅ | action、visible属性 |
| **区域闭合性** | ✅ | ✅ | 自动闭合未闭合的区域 |
| **缺失标签补充** | ⚠️ | ⚠️ | 智能推断部分标签 |
| **类型标准化** | ✅ | ✅ | 区域类型映射到标准值 |
| **数值格式修复** | ⚠️ | ⚠️ | 坐标范围、层级格式 |
| **语义命名修复** | ❌ | ⚠️ | 仅Semantic版本支持 |
| **跨楼层通道** | ❌ | ⚠️ | 仅Semantic版本支持 |
| **层级一致性** | ⚠️ | ⚠️ | 父子区域层级同步 |

**图例**：✅ 完全支持 | ⚠️ 部分支持 | ❌ 不支持

## 修复级别说明

### SAFE（安全修复）
- **特点**：不会改变文件语义，完全安全
- **包括**：
  - 根元素标准化（版本号、generator）
  - 属性补充（action、visible）
  - 区域闭合性修复
  - 类型标准化映射
- **默认启用**：是

### MODERATE（中等修复）
- **特点**：可能轻微改变语义，需要谨慎使用
- **包括**：
  - 坐标范围修正
  - 层级格式标准化
  - 智能标签推断
  - 语义命名格式修复
  - 层级一致性修复
- **启用方式**：`--enable-moderate`

### RISKY（风险修复）
- **特点**：可能显著改变语义，极少使用
- **包括**：
  - 复杂的数据推断
  - 结构性修改
- **启用方式**：`--enable-risky`

## 使用方法

### Fix_ID版本修复工具

```bash
# 基本用法 - 仅安全修复
python auto_fix_osmag_fixid.py file.osm

# 启用中等风险修复
python auto_fix_osmag_fixid.py file.osm --enable-moderate

# 修复到指定输出文件
python auto_fix_osmag_fixid.py file.osm --output fixed_file.osm

# 批量修复目录
python auto_fix_osmag_fixid.py /path/to/directory/ --enable-moderate --save-report

# 修复到指定输出目录
python auto_fix_osmag_fixid.py /path/to/input/ --output-dir /path/to/output/
```

### Semantic版本修复工具

```bash
# 基本用法 - 仅安全修复
python auto_fix_osmag_semantic.py file.osm

# 启用中等风险修复
python auto_fix_osmag_semantic.py file.osm --enable-moderate

# 修复到指定输出文件
python auto_fix_osmag_semantic.py file.osm --output fixed_file.osm

# 批量修复目录
python auto_fix_osmag_semantic.py /path/to/directory/ --enable-moderate --save-report

# 修复到指定输出目录
python auto_fix_osmag_semantic.py /path/to/input/ --output-dir /path/to/output/
```

## 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `paths` | 要修复的文件路径或目录路径（必需） | - |
| `-o, --output` | 输出文件路径（单文件修复时） | 覆盖原文件 |
| `--output-dir` | 输出目录路径（批量修复时） | 覆盖原文件 |
| `--enable-moderate` | 启用中等风险修复 | 关闭 |
| `--enable-risky` | 启用高风险修复 | 关闭 |
| `--no-backup` | 不创建备份文件 | 创建备份 |
| `-s, --save-report` | 保存修复报告到JSON文件 | 不保存 |
| `--version` | 显示版本信息 | - |
| `-h, --help` | 显示帮助信息 | - |

## 修复流程

### 1. 修复前验证
- 使用相应的验证工具检查文件状态
- 记录修复前的错误和警告数量

### 2. 备份机制
- 自动创建带时间戳的备份文件
- 格式：`原文件名.backup_YYYYMMDD_HHMMSS`
- 可通过 `--no-backup` 禁用

### 3. 执行修复
- 按修复级别顺序执行
- 记录每个修复操作的详细信息
- 提供修复前后的值对比

### 4. 修复后验证
- 重新验证修复后的文件
- 对比修复前后的问题数量
- 显示修复效果统计

### 5. 报告生成
- 控制台显示详细的修复报告
- 可选择保存JSON格式的修复报告
- 包含统计信息和修复详情

## 修复示例

### 成功修复示例

```
🔧 正在修复Semantic版本文件: SIST1_2F.osm
📁 已创建备份: SIST1_2F.osm.backup_20240604_143533
✅ 文件已修复: SIST1_2F.osm

📊 修复效果对比:
  错误数: 31 → 28 (减少 3)
  警告数: 3 → 6 (减少 -3)
  验证状态: ❌ → ❌

📋 详细修复列表:
  SAFE:
    AREA (3 个):
      ✅ 修复区域闭合性 [元素: -189721]
      ✅ 修复区域闭合性 [元素: -191826]
      ✅ 修复区域闭合性 [元素: -192870]

  MODERATE:
    LEVEL_CONSISTENCY (1 个):
      ✅ 同步子区域层级到父区域 [元素: -188595]
```

### 无需修复示例

```
🔧 正在修复Fix_ID版本文件: SIST1_D_F2.osm
📁 已创建备份: SIST1_D_F2.osm.backup_20240604_143524
ℹ️  文件无需修复: SIST1_D_F2.osm

📊 修复统计:
  处理文件数: 1
  修复文件数: 0
  总修复数: 0
```

## 安全机制

### 1. 备份保护
- 修复前自动创建备份
- 备份文件包含时间戳，避免覆盖
- 修复失败时原文件保持不变

### 2. 保守修复策略
- 默认只启用安全修复
- 中等和高风险修复需要显式启用
- 对于可能有多种解决方案的问题，选择最保守的方案

### 3. 验证机制
- 修复前后都进行完整验证
- 提供详细的修复效果对比
- 确保修复不会引入新问题

### 4. 错误处理
- 完善的异常处理机制
- 修复失败时提供详细错误信息
- 支持部分修复成功的情况

## 注意事项

### 1. 修复限制
- 某些问题无法自动修复，需要人工干预
- 复杂的引用关系问题通常需要手动处理
- 语义相关的问题修复需要谨慎

### 2. 使用建议
- 首次使用建议先在测试文件上验证
- 重要文件修复前请确保有完整备份
- 启用中等/高风险修复前请仔细评估

### 3. 版本兼容性
- 确保使用正确的修复工具（Fix_ID vs Semantic）
- 修复工具与验证工具版本保持同步
- 定期更新工具以获得最新修复能力

## 故障排除

### 常见问题

1. **导入错误**
   ```
   错误: 无法导入test_compatibility模块
   解决: 确保验证工具文件在同一目录下
   ```

2. **权限错误**
   ```
   错误: 无法写入文件
   解决: 检查文件和目录的写入权限
   ```

3. **XML解析错误**
   ```
   错误: XML解析失败
   解决: 检查文件格式，可能需要手动修复XML结构
   ```

### 获取帮助

- 使用 `--help` 参数查看详细使用说明
- 查看修复报告了解具体修复内容
- 对比修复前后的验证结果分析问题

## 总结

这两个自动修复工具为osmAG文件的维护提供了强大的自动化支持，能够：

- **提高效率**：自动修复常见问题，减少手动工作
- **保证安全**：多级修复策略和完善的备份机制
- **提供洞察**：详细的修复报告和效果对比
- **支持批量**：高效处理大量文件的修复需求

通过合理使用这些工具，可以显著提高osmAG文件的质量和兼容性。
